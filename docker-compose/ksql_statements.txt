SET 'auto.offset.reset'='earliest';

CREATE STREAM orders_raw WITH (KAFKA_TOPIC='orders_raw', VALUE_FORMAT='AVRO');
describe orders_raw;

CREATE STREAM ORDERS_3NF WITH (VALUE_FORMAT='AVRO', TIMESTAMP='ORDERDATE', timestamp_format='M/d/yyyy h:mm') AS 
  SELECT ORDERNUMBER, ORDERDATE, STATUS, QTR_ID, MONTH_ID, YEAR_ID, DEALSIZE, CUSTOMERNAME 
  FROM orders_raw PARTITION BY ORDERNUMBER;
  
CREATE TABLE T_ORDERS_3NF WITH (KAFKA_TOPIC='ORDERS_3NF', VALUE_FORMAT='AVRO', KEY='ORDERNUMBER');

CREATE STREAM ORDERLINES_3NF WITH (VALUE_FORMAT='AVRO') AS 
  SELECT ORDERNUMBER, ORDERLINENUMBER, QUANTITYORDERED, PRICEEACH, PRODUCTCODE FROM orders_raw;

CREATE STREAM CUSTOMERS_3NF WITH (VALUE_FORMAT='AVRO') AS 
  SELECT CUSTOMERNAME, PHONE, ADDRESSLINE1, ADDRESSLINE2, CITY, STATE, POSTALCODE, COUNTRY, CONTACTLASTNAME, CONTACTFIRSTNAME 
  FROM orders_raw PARTITION BY CUSTOMERNAME;

CREATE TABLE T_CUSTOMERS_3NF WITH (KAFKA_TOPIC='CUSTOMERS_3NF', VALUE_FORMAT='AVRO', KEY='CUSTOMERNAME');

CREATE STREAM PRODUCTS_3NF WITH (VALUE_FORMAT='AVRO') AS 
  SELECT PRODUCTCODE,  PRODUCTLINE, MSRP 
  FROM orders_raw PARTITION BY PRODUCTCODE;

CREATE TABLE T_PRODUCTS_3NF WITH (KAFKA_TOPIC='PRODUCTS_3NF', VALUE_FORMAT='AVRO', KEY='PRODUCTCODE');

CREATE STREAM COUNTRIES_3NF WITH (VALUE_FORMAT=‘AVRO’) AS 
  SELECT COUNTRY, TERRITORY 
  FROM orders_raw PARTITION BY COUNTRY;

CREATE TABLE T_COUNTRIES_3NF WITH (KAFKA_TOPIC='COUNTRIES_3NF', VALUE_FORMAT='AVRO', KEY='COUNTRY’);


CREATE STREAM orderlines1 AS
  SELECT ol.*, o.ORDERDATE, o.STATUS, o.QTR_ID, o.MONTH_ID, o.YEAR_ID, o.DEALSIZE, o.CUSTOMERNAME
  FROM ORDERLINES_3NF ol
  LEFT JOIN T_ORDERS_3NF o ON ol.ORDERNUMBER = o.ORDERNUMBER;
  
CREATE STREAM orderlines2 AS
  SELECT ol1.*, c.PHONE, c.ADDRESSLINE1, c.ADDRESSLINE2, c.CITY, c.STATE, c.POSTALCODE, c.COUNTRY, c.CONTACTLASTNAME, c.CONTACTFIRSTNAME
  FROM orderlines1 ol1
  LEFT JOIN T_CUSTOMERS_3NF c ON ol1.CUSTOMERNAME = c.CUSTOMERNAME;
  
CREATE STREAM orderlines3 AS
  SELECT *, p.PRODUCTLINE, p.MSRP 
  FROM orderlines2 ol2
  LEFT JOIN T_PRODUCTS_3NF p ON ol2.OL1_OL_PRODUCTCODE = p.PRODUCTCODE;

CREATE STREAM orderlines4 AS
  SELECT *, c.TERRITORY
  FROM orderlines3
  LEFT JOIN T_COUNTRIES_3NF c ON OL2_COUNTRY = c.COUNTRY;
